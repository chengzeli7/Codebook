**密码管理器App需求开发文档 (PRD)**  
**文档版本**: v1.0  
**适用平台**: Android (minSdk 24, targetSdk 34)  
**技术栈**: Kotlin + Jetpack Compose + Room + Hilt  

---

## 1. 项目概述

### 1.1 产品定位
开发一款**完全离线**的本地密码管理器，核心卖点为“零网络传输+硬件级加密+智能剪贴板捕获”。用户数据仅存储于设备本地，通过生物识别+主密码双重保护。

### 1.2 核心功能清单
| 模块 | 功能点 | 优先级 |
|------|--------|--------|
| 核心 | 密码增删改查、分类管理、本地搜索 | P0 |
| 安全 | 生物识别认证、防截屏/录屏、数据库加密 | P0 |
| 智能 | 剪贴板内容识别与快速保存 | P1 |

---

## 2. 功能需求 (Functional Requirements)

### 2.1 基础密码管理 (FR-001)
**描述**: 密码的CRUD操作及展示
- **FR-001.1 列表展示**: 以卡片列表展示密码条目，支持按分类筛选（社交/金融/工作/其他）。
- **FR-001.2 搜索**: 顶部搜索栏，支持模糊匹配标题、用户名、URL，实时搜索(Debounce 300ms)。
- **FR-001.3 详情页**: 展示站点名称、用户名、密码（默认隐藏）、URL、备注。提供"显示密码"、"复制账号"、"复制密码"按钮。
- **FR-001.4 分类管理**: 预设4个默认分类，不支持用户自定义分类（减少复杂度）。

### 2.2 生物识别认证 (FR-002)
**描述**: 应用级安全入口
- **FR-002.1 首次启动**: 强制设置主密码(Master Password，6位数字或字母组合)，使用AES-256加密存储于KeyStore。
- **FR-002.2 生物识别绑定**: 主密码设置后，提示用户绑定指纹/面部识别。生物识别通过后，自动解密主密码用于解锁数据库。
- **FR-002.3 认证触发时机**: 
  - 冷启动时强制认证
  - 切回前台时：若App在后台超过**5分钟**，再次进入需重新认证
- **FR-002.4 失败回退**: 生物识别失败3次后，强制要求输入主密码。

### 2.3 剪贴板智能识别 (FR-003)
**描述**: 自动检测剪贴板中的账号密码信息并提示保存
- **FR-003.1 检测时机**: 
  - App从后台切换到前台时检测一次
  - App在前台时，监听剪贴板变化（Android 10+需关注前台服务限制）
- **FR-003.2 识别规则** (满足任一即触发):
  - 正则匹配：包含`password[:：]\s*\S+` 或 `pwd[:：]\s*\S+` 或 `密码[:：]\s*\S+`
  - 组合匹配：同时包含邮箱/手机号格式 + 6位以上连续字符（疑似密码）
  - 分隔符模式：`账号/密码` 或 `username/password` 成对出现
- **FR-003.3 弹窗交互**: 检测到后弹出BottomSheet，预填充解析出的账号密码，用户可编辑后一键保存。提供"忽略本次"和"不再提示"选项。
- **FR-003.4 隐私保护**: 检测完成后立即清空应用内存中的剪贴板缓存，不记录历史。

### 2.4 防截屏保护 (FR-004)
**描述**: 防止敏感信息被截屏或录屏
- **FR-004.1 全局Flag**: 所有Activity必须设置 `FLAG_SECURE`，禁止系统截屏、录屏。
- **FR-004.2 最近任务**: 在最近任务列表中显示空白/黑屏（系统默认行为配合FLAG_SECURE）。
- **FR-004.3 例外**: 允许用户设置"允许截屏"开关（隐藏在高级设置中，默认关闭）。

---

## 3. 非功能需求 (Non-Functional Requirements)

### 3.1 安全规范 (NFR-001) - **关键**
| 项目 | 要求 |
|------|------|
| 数据库加密 | 使用SQLCipher，密钥由KeyStore随机生成，与设备绑定 |
| 字段加密 | 密码字段需二次AES加密（防Root后直接Dump数据库） |
| 密钥存储 | 主密钥、数据库密钥必须存储于Android Keystore System，禁止硬编码或SharedPreferences明文存储 |
| 内存安全 | 密码字符串使用`CharArray`而非`String`，使用后立即`fill('\u0000')`清零 |
| 剪贴板安全 | 复制密码后，60秒后自动清空系统剪贴板（若内容仍匹配） |

### 3.2 性能要求 (NFR-002)
- 列表页加载1000条数据时，冷启动时间<500ms
- 搜索响应延迟<100ms（本地数据库）
- 生物识别验证流程<2秒

### 3.3 兼容性 (NFR-003)
- 支持Android 7.0 (API 24) 至 Android 14 (API 34)
- 生物识别优先使用AndroidX Biometric库，兼容指纹和面部识别
- 无生物识别设备的回退方案：主密码+设备PIN

---

## 4. 数据模型设计

### 4.1 数据库实体 (Room Entity)
```kotlin
@Entity(tableName = "passwords")
data class PasswordEntity(
    @PrimaryKey val id: String = UUID.randomUUID().toString(),
    val title: String,              // 站点名称
    val username: String,           // 账号（可明文存储或轻度混淆）
    val encryptedPassword: String,  // AES加密后的密码(Base64)
    val category: String,           // 枚举：SOCIAL, FINANCE, WORK, OTHER
    val url: String?,               // 关联网址
    val note: String?,              // 备注
    val createdAt: Long = System.currentTimeMillis(),
    val updatedAt: Long = System.currentTimeMillis()
)
```

### 4.2 分类枚举
```kotlin
enum class Category(val displayName: String, val icon: Int) {
    SOCIAL("社交账号", R.drawable.ic_social),
    FINANCE("金融银行", R.drawable.ic_finance),
    WORK("工作相关", R.drawable.ic_work),
    OTHER("其他", R.drawable.ic_other)
}
```

---

## 5. 技术实现细节

### 5.1 生物识别实现 (核心代码规范)
```kotlin
// 使用AndroidX Biometric库
val promptInfo = BiometricPrompt.PromptInfo.Builder()
    .setTitle("验证身份")
    .setSubtitle("使用指纹或面部识别解锁")
    .setAllowedAuthenticators(
        BIOMETRIC_STRONG or DEVICE_CREDENTIAL  // 允许生物识别或设备凭证
    )
    .build()

// 关键：生物识别通过后，从KeyStore取出数据库密钥
// 禁止将主密码直接存储在内存中，应使用Session Key机制
```

### 5.2 剪贴板检测实现
```kotlin
// 在BaseActivity或Application.onResume中触发
fun checkClipboard() {
    if (!isAppInForeground()) return  // Android 10+ 后台限制
    
    val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
    val clip = clipboard.primaryClip?.getItemAt(0)?.text?.toString() ?: return
    
    // 正则检测逻辑
    val patterns = listOf(
        Regex("(?:账号|用户名|username)[:：]\\s*(\\S+).*?(?:密码|password)[:：]\\s*(\\S+)", RegexOption.DOT_MATCHES_ALL),
        Regex("(?:密码|password)[:：]\\s*(\\S+)")
    )
    
    patterns.forEach { regex ->
        regex.find(clip)?.let { matchResult ->
            showSavePasswordDialog(matchResult)
            return
        }
    }
}
```

### 5.3 防截屏实现
```kotlin
// BaseActivity.onCreate中设置
window.setFlags(
    WindowManager.LayoutParams.FLAG_SECURE,
    WindowManager.LayoutParams.FLAG_SECURE
)
```

---

## 6. 用户界面流程 (UI Flow)

### 6.1 认证流程
```
启动App → 检测生物识别硬件 → 显示生物识别Prompt → [成功]→ 解密数据库 → 进入主页
                                    ↓
                              [失败/取消]→ 显示主密码输入框 → 验证Hash → 进入主页
```

### 6.2 剪贴板识别流程
```
用户复制内容 → 切换回App → 检测剪贴板 → 匹配成功 → 弹出BottomSheet
                                          ↓
                                    用户点击保存 → 填充至新增页/直接保存
                                    用户点击忽略 → 清空剪贴板标记（30分钟内不再提示同一内容）
```

---

## 7. 验收标准 (Acceptance Criteria)

### 7.1 安全测试用例
- [ ] 使用ADB `screencap` 命令无法截取App界面（黑屏）
- [ ] 导出/data/data/[package]/databases/下的数据库文件，使用SQLite Browser打开显示乱码（SQLCipher验证）
- [ ] Root环境下，从内存Dump中无法搜索到明文密码字符串（内存清零验证）

### 7.2 功能测试用例
- [ ] 复制文本"账号：test@qq.com 密码：123456"后切换回App，弹出保存提示
- [ ] 复制"今天的密码是：abc123"后切换回App，触发识别
- [ ] 后台停留6分钟后回到前台，强制要求重新指纹验证
- [ ] 搜索"京东"可正确筛选出标题含"京东"的条目

### 7.3 兼容性测试
- [ ] Android 8.0 (无面部识别，仅有指纹) 设备可正常使用指纹
- [ ] Android 14 设备支持面部识别
- [ ] 无生物识别设备（如模拟器）可正常使用主密码进入

---

## 8. 风险与限制

| 风险点 | 描述 | 缓解方案 |
|--------|------|----------|
| 剪贴板限制 | Android 10+ 后台应用无法读取剪贴板，只能在App前台时检测 | 文档已明确限制，仅检测"切换回前台"和"前台时复制"两种场景 |
| 生物识别误判 | 面部识别在弱光环境下识别率低 | 必须提供主密码回退方案 |
| 密钥丢失 | 用户清除数据或更换设备后，KeyStore中的密钥丢失，数据永久无法解密 | 添加首次使用时的强提醒："数据仅保存在本机，卸载或清除数据将永久丢失" |
| 剪贴板隐私争议 | 用户可能担心App读取剪贴板侵犯隐私 | 在首次启动时明确申请权限说明，并在设置中提供"关闭剪贴板监听"开关 |

---

## 9. 交付物清单

1.  **源代码**: Kotlin项目，遵循MVVM架构
2.  **数据库加密密钥管理文档**: 详细说明KeyStore使用方式
3.  **安全测试报告**: 包含截屏测试、Root环境测试、内存Dump测试结果
4.  **用户手册**: 如何设置主密码、如何开启生物识别、数据备份警告

---

**备注**: 本文档为技术交付文档，开发人员需在编码前详细阅读"安全规范"章节。任何涉及密码学实现的代码必须经过Code Review。